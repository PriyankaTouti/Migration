CREATE PROCEDURE [dbo].[MPI_FETCH_INC_CUST_HOLDING_DATA_FROM_DATAMART](@OWNERID INT)          
AS           
/*           
 Description - Fetch customer data from Datamart          
 Created On - 24-01-2023 | Created By - Pradyuman Sharma          
 EXEC MPI_FETCH_INC_CUST_HOLDING_DATA_FROM_DATAMART 985;  
*/          
BEGIN   
  DECLARE @DATEKEY_CUST DATETIME,  
          @BATCH        FLOAT,  
    @DATEKEY      FLOAT;  
    
  /*BUSINESSNEXT LT*/  
  SELECT TOP 1 @BATCH = AS_OF_DATE FROM MPI_CUST_HOLDING_INC_LT ORDER BY AS_OF_DATE DESC;  
  IF(@BATCH IS NULL) BEGIN  
   SET @BATCH = '20240301';  
  END;  
  PRINT CAST(@BATCH AS INT);  
  /*DATAMART LOG*/  
  SELECT TOP 1 @DATEKEY_CUST = LAST_LOAD_DATE  
  FROM [10.2.1.93].[MB_EDW_REPORTS].[DBO].[LOS_LOADCHECK]   
  WHERE TABLE_NAME = N'LOS_FILECHECK_ACCT'  
  ORDER BY LAST_LOAD_DATE DESC;  
  SET @DATEKEY = CAST(REPLACE(CONVERT(CHAR(10), @DATEKEY_CUST, 112), N'-', N'') AS FLOAT);  
  PRINT CAST(@DATEKEY AS INT);  
  
  TRUNCATE TABLE MPI_CUST_HOLDING_INC_LT;  
  
  IF(@BATCH >= @DATEKEY) BEGIN  
    PRINT 'DO NOTHING';  
 --;THROW 999999, N'SAME DAY DATA ALREADY PRESENT IN LT.', 1;  
  END   
  ELSE BEGIN  
    
  PRINT 'INSERT STARTED';  
  /*INSERT DATA IN LT*/  
  
  INSERT INTO MPI_CUST_HOLDING_INC_LT(AS_OF_DATE,CIF,PRODUCT_CATEGORY,PRODUCT,ACCT_NO,STATUS,CUST_REL,CENTER_RM,ACCT_HANDLING,LOAN_LIMIT,OSB,MONTHLY_AMORT,  
     LOAN_TERM,MOB,UTIL_RATE,DATE_OPENED,DATE_CLOSED,SORT_FLAG)          
  SELECT DATE_KEY,CUST_NO,ACCT_TYPE,PRODUCT,ACCT_NO,STATUS,CUST_REL,BRANCH_NAME,ACCT_HANDLING,LOAN_LIMIT,OSB,MONTHLY_AMORT,  
     LOAN_TERM,MOB,UTIL_RATE,DATE_OPENED,DATE_CLOSED,SORT_FLAG          
  FROM [10.2.1.93].[MB_EDW_REPORTS].[dbo].[LOS_FILECHECK_ACCT];  
  
  END;  
  
END;
