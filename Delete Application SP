USE [MPI_DEV]
GO
/****** Object:  StoredProcedure [dbo].[MPI_DELETE_APPILCATION]    Script Date: 05-12-2024 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER   PROCEDURE [dbo].[MPI_DELETE_APPILCATION] (@OWNERID INT)         
AS         
/*=======================================================================          
 CREATED BY: PRIYANKA TOUTI; CREATED ON: 28-05-24; 
 MODIFIED BY:ALI ASGAR BAJI ; MODIFIED ON: 30-JULY-2024; 
 DETAILS: DELETE ALL APPLICATION INFORMATION RELATED TO FA    
 EXEC MPI_DELETE_APPILCATION 985    
=========================================================================*/         
BEGIN 

	/*-------------------------- VARIABLE DECLARATION ------------------------*/
	DECLARE @GETCURRENTDATE DATETIME = GETUTCDATE(); 
	DECLARE @GETTOMMOROWDATE DATE = CONVERT(DATE,GETDATE()+2);    
	DECLARE @BATCHNO INT,         
			@JOBID INT,         
			@PASSID INT,         
	        @TASKID INT,         
	        @SUCCESSCOUNT INT = 0,         
	        @FAILURECOUNT INT = 0,         
	        @COUNT INT = 0,         
	        @ERRORMESSAGE NVARCHAR(256);         
	      
	/*--------------------------GET THE JOB DETAILS TO UPDATE THE COUNT AND LOGS ------------------------*/            
	SELECT @JOBID = JOBID FROM CIS_JOB WHERE OWNERID = @OWNERID AND JOBNAME = N'MPI - Application Data Quick Checks';
	SELECT @PASSID = PASSID FROM CIS_PASS WHERE OWNERID = @OWNERID AND PASSNAME = N'MPI - Delete Application(C,S)';         
	SELECT @TASKID = TASKID	FROM CIS_TASK WHERE OWNERID = @OWNERID AND JOBID = @JOBID AND PASSID = @PASSID AND TASKNAME = N'MPI - Delete Application Inactive(C,S)';         
	SET @BATCHNO = DBO.CIS_GET_BATCH_NUMBER(@OWNERID, @JOBID);         
	
	
	/*-------------------------- STORE PROCEDURE LOGIC STATED FOR APPLICATION DELETION------------------------*/
	BEGIN TRY
		INSERT INTO MPI_APPLICATION_DELETION_LOG 
		(
			OWNERID,
			APPLICATIONID,
			FIRSTNAME,
			MIDDLENAME,
			LASTNAME,
			STATUSCODEID,
			PHONE,
			MOBILE,
			DOB,
			BORROWERTAG,
			CREATEDBY,
			CREATEDON,
			LASTMODIFIEDBY,
			LASTMODIFIEDON,
			APPLICATIONNAME,
			RELATEDTOID,
			RELATEDTONAME,
			RELATEDTOTYPEID)
		SELECT 
			A.OWNERID AS OWNERID,
			A.APPLICATIONID AS APPLICATIONID,
			A.FIRSTNAME AS FIRSTNAME, 
			A.MIDDLENAME AS MIDDLENAME,
			A.LASTNAME AS LASTNAME,
			A.STATUSCODEID AS STATUSCODEID,
			A.PHONE AS PHONE,
			A.MOBILE AS MOBILE,
			A3.APL_EX3_34 AS DOB,
			A1.APL_EX1_53 AS BORROWERTAG,
			A.CREATEDBY AS CREATEDBY,
			A.CREATEDON AS CREATEDON,
			A.LASTMODIFIEDBY AS LASTMODIFIEDBY,
			A.LASTMODIFIEDON AS LASTMODIFIEDON,
			A.APPLICATIONNAME AS APPLICATIONNAME,
			A.RELATEDTOID AS RELATEDTOID,
			A.RELATEDTONAME AS RELATEDTONAME,
			A.RELATEDTOTYPEID AS RELATEDTOTYPEID
		FROM APPLICATION A
		INNER JOIN APL_EX1 A1 ON A.OWNERID = A1.OWNERID AND A.APPLICATIONID = A1.APL_EX1_ID
		INNER JOIN APL_EX3 A3 ON A.OWNERID = A3.OWNERID AND A.APPLICATIONID = A3.APL_EX3_ID
		INNER JOIN APL_EX5 A5 ON A.OWNERID = A5.OWNERID AND A.APPLICATIONID = A5.APL_EX5_ID
		WHERE A.OWNERID = @OWNERID AND A1.APL_EX1_53 != 'P' AND A5.APL_EX5_142 = 1;

		SELECT 
			A.OWNERID AS OWNERID,
			A.ApplicationId AS APPLICATIONID 
			INTO #TEMPAPPLICATION
			FROM APPLICATION A
		INNER JOIN APL_EX1 A1 ON A.OWNERID = A1.OWNERID AND A.APPLICATIONID = A1.APL_EX1_ID
		INNER JOIN APL_EX5 A5 ON A.OWNERID = A5.OWNERID AND A.APPLICATIONID = A5.APL_EX5_ID
		WHERE  A.OWNERID = @OWNERID AND A1.APL_EX1_53 != 'P' AND A5.APL_EX5_142 = 1;

		SELECT 
			V.OWNERID AS OWNERID,
			V.CustomObjectId AS VERIFICATIONID 
			INTO #TEMPVERIFICATION
			FROM VERIFICATION V
		INNER JOIN #TEMPAPPLICATION TMP ON V.OWNERID = TMP.OWNERID AND V.RELATEDTOTYPEID=162 AND V.RELATEDTOID= TMP.APPLICATIONID


		/*-----------------------------DELETE RECORD FROM APPLICATION OBJECT----------------------------------------*/
		DELETE A FROM APPLICATION A
		INNER JOIN #TEMPAPPLICATION TMP ON A.OwnerID=TMP.OWNERID AND A.ApplicationId=TMP.APPLICATIONID
		WHERE A.OwnerID=985;

		DELETE A FROM APPLICATIONHISTORY A
		INNER JOIN #TEMPAPPLICATION TMP ON A.OwnerID=TMP.OWNERID AND A.ApplicationId=TMP.APPLICATIONID
		WHERE A.OwnerID=985;

		DELETE A1 FROM Apl_ex1 A1
		INNER JOIN #TEMPAPPLICATION TMP ON A1.OwnerID=TMP.OWNERID AND A1.Apl_ex1_Id=TMP.APPLICATIONID
		WHERE A1.OwnerID=985;

		DELETE AH1 FROM APL_EX1_HS AH1
		INNER JOIN #TEMPAPPLICATION TMP ON AH1.OwnerID=TMP.OWNERID AND AH1.Apl_ex1_Id=TMP.APPLICATIONID
		WHERE AH1.OwnerID=985;

		DELETE A2 FROM Apl_ex2 A2
		INNER JOIN #TEMPAPPLICATION TMP ON A2.OwnerID=TMP.OWNERID AND A2.Apl_ex2_Id=TMP.APPLICATIONID
		WHERE A2.OwnerID=985;

		DELETE AH2 FROM APL_EX2_HS AH2
		INNER JOIN #TEMPAPPLICATION TMP ON AH2.OwnerID=TMP.OWNERID AND AH2.Apl_ex2_Id=TMP.APPLICATIONID
		WHERE AH2.OwnerID=985;

		DELETE A3 FROM Apl_ex3 A3
		INNER JOIN #TEMPAPPLICATION TMP ON A3.OwnerID=TMP.OWNERID AND A3.Apl_ex3_Id=TMP.APPLICATIONID
		WHERE A3.OwnerID=985;

		DELETE AH3 FROM APL_EX3_HS AH3
		INNER JOIN #TEMPAPPLICATION TMP ON AH3.OwnerID=TMP.OWNERID AND AH3.Apl_ex3_Id=TMP.APPLICATIONID
		WHERE AH3.OwnerID=985;

		DELETE A4 FROM Apl_ex4 A4
		INNER JOIN #TEMPAPPLICATION TMP ON A4.OwnerID=TMP.OWNERID AND A4.Apl_ex4_Id=TMP.APPLICATIONID
		WHERE A4.OwnerID=985;

		DELETE AH4 FROM APL_EX4_HS AH4
		INNER JOIN #TEMPAPPLICATION TMP ON AH4.OwnerID=TMP.OWNERID AND AH4.Apl_ex4_Id=TMP.APPLICATIONID
		WHERE AH4.OwnerID=985;

        DELETE A5 FROM Apl_ex5 A5
		INNER JOIN #TEMPAPPLICATION TMP ON A5.OwnerID=TMP.OWNERID AND A5.Apl_ex5_Id=TMP.APPLICATIONID
		WHERE A5.OwnerID=985;

		DELETE AH5 FROM APL_EX5_HS AH5
		INNER JOIN #TEMPAPPLICATION TMP ON AH5.OwnerID=TMP.OWNERID AND AH5.Apl_ex5_Id=TMP.APPLICATIONID
		WHERE AH5.OwnerID=985;


		/*----------------------DELETE RECORD FROM VERIFICATION OBJECT---------------------------------*/
		DELETE V FROM VERIFICATION V
		INNER JOIN #TEMPVERIFICATION TMPV ON V.OwnerID=TMPV.OWNERID AND V.CustomObjectId=TMPV.VERIFICATIONID
		WHERE V.OwnerID=985;

		DELETE VH FROM VERIFICATIONHISTORY VH
		INNER JOIN #TEMPVERIFICATION TMPV ON VH.OwnerID=TMPV.OWNERID AND VH.CustomObjectId=TMPV.VERIFICATIONID
		WHERE VH.OwnerID=985;

		DELETE V1 FROM VER_EX1 V1
		INNER JOIN #TEMPVERIFICATION TMPV ON V1.OwnerID=TMPV.OWNERID AND V1.Ver_ex1_ID=TMPV.VERIFICATIONID
		WHERE V1.OwnerID=985;

		DELETE VH1 FROM VER_EX1_HS VH1
		INNER JOIN #TEMPVERIFICATION TMPV ON VH1.OwnerID=TMPV.OWNERID AND VH1.Ver_ex1_ID=TMPV.VERIFICATIONID
		WHERE VH1.OwnerID=985;

        DELETE V2 FROM VER_EX2 V2
		INNER JOIN #TEMPVERIFICATION TMPV ON V2.OwnerID=TMPV.OWNERID AND V2.Ver_ex2_ID=TMPV.VERIFICATIONID
		WHERE V2.OwnerID=985;

		DELETE VH2 FROM VER_EX2_HS VH2
		INNER JOIN #TEMPVERIFICATION TMPV ON VH2.OwnerID=TMPV.OWNERID AND VH2.Ver_ex2_ID=TMPV.VERIFICATIONID
		WHERE VH2.OwnerID=985;

		DELETE V3 FROM VER_EX3 V3
		INNER JOIN #TEMPVERIFICATION TMPV ON V3.OwnerID=TMPV.OWNERID AND V3.Ver_ex3_ID=TMPV.VERIFICATIONID
		WHERE V3.OwnerID=985;

		DELETE VH3 FROM VER_EX3_HS VH3
		INNER JOIN #TEMPVERIFICATION TMPV ON VH3.OwnerID=TMPV.OWNERID AND VH3.Ver_ex3_ID=TMPV.VERIFICATIONID
		WHERE VH3.OwnerID=985;

		DELETE V4 FROM VER_EX4 V4
		INNER JOIN #TEMPVERIFICATION TMPV ON V4.OwnerID=TMPV.OWNERID AND V4.Ver_ex4_ID=TMPV.VERIFICATIONID
		WHERE V4.OwnerID=985;

		DELETE VH4 FROM VER_EX4_HS VH4
		INNER JOIN #TEMPVERIFICATION TMPV ON VH4.OwnerID=TMPV.OWNERID AND VH4.Ver_ex4_ID=TMPV.VERIFICATIONID
		WHERE VH4.OwnerID=985;

		DELETE V5 FROM VER_EX5 V5
		INNER JOIN #TEMPVERIFICATION TMPV ON V5.OwnerID=TMPV.OWNERID AND V5.Ver_ex5_ID=TMPV.VERIFICATIONID
		WHERE V5.OwnerID=985;

		DELETE VH5 FROM VER_EX5_HS VH5
		INNER JOIN #TEMPVERIFICATION TMPV ON VH5.OwnerID=TMPV.OWNERID AND VH5.Ver_ex5_ID=TMPV.VERIFICATIONID
		WHERE VH5.OwnerID=985;

		/*------------------DELETE RECORD FROM LIABILITY OBJECT------------------------*/
		DELETE L FROM LIABILITY L
		INNER JOIN #TEMPAPPLICATION TMP ON L.OWNERID = TMP.OWNERID AND L.RELATEDTOID=162 AND  L.RELATEDTOID=TMP.APPLICATIONID  
		WHERE L.OWNERID=985;

		SET @SUCCESSCOUNT=@SUCCESSCOUNT + @@ROWCOUNT;
		
	END TRY         
	BEGIN CATCH         
		-- CAPTURING THE FAILURE REASON              
		SELECT @ERRORMESSAGE = SUBSTRING(ERROR_MESSAGE(), 0, 255); 
		IF @ERRORMESSAGE != '' BEGIN
			SELECT @COUNT = 1;
		END

		-- UPDATING THE LT.         
		UPDATE LT SET LT.ERRORCODE = 1,LT.ERRORMESSAGE = @ERRORMESSAGE         
		FROM  MPI_DEALER_LT LT WHERE LT.ERRORCODE = 0;         
	END CATCH              
         
   SET @FAILURECOUNT = @COUNT - @SUCCESSCOUNT;         
   UPDATE CIS_LOG         
   SET  FAILURECOUNT = @FAILURECOUNT,SUCCESSCOUNT = @SUCCESSCOUNT         
   WHERE OWNERID = @OWNERID         
       AND BATCHNUMBER = @BATCHNO         
       AND SOURCETYPEID = 3         
       AND SOURCEID = @TASKID;         
END
